include:
  - https://cnb.cool/1024hub/workflow/-/blob/master/pipeline/deploy/be-go-single.yml

# 定时任务：每日 03:00 生成工作日报（Asia/Shanghai）
# 说明：尝试安装并在 zen 模式下运行 opencode；若失败，回落到内置 git 汇总脚本。
# 待确认：
# - 是否使用“上一自然日（昨天 00:00:00~今天 00:00:00）”作为日报时间范围。
# - API Key 建议放入平台密钥仓库，通过 imports 注入，避免明文保存在仓库。
main:
  "crontab: 0 3 * * *":
    - name: daily-opencode-report
  dispatch:
    - name: manual-opencode-report
      env:
        TZ: Asia/Shanghai
        RUNNER_ARCH: cnb:arch:amd64
        OPENCODE_MODEL: "opencode/grok-code"
        # 使用上一自然日作为日报统计范围
        REPORT_TIMEFRAME: "yesterday"
        ZEN_MODE: "1"
        # 定时任务改为：AI 必达 + 采样补丁
        REQUIRE_AI_SUMMARY: "1"
        REPORT_DIFF_MODE: "sampled_patch"
        REPORT_DIFF_CHAR_BUDGET: "200000"
        REPORT_DIFF_TOP_FILES: "20"
        REPORT_DIFF_HUNKS_PER_FILE: "3"
        REPORT_DIFF_MAX_COMMITS: "100"
        REPORT_NUMSTAT_LINES: "5000"
        REPORT_EXCLUDE_GLOBS: "node_modules/**;dist/**;vendor/**;*.min.*;*.png;*.jpg;*.jpeg;*.gif;*.webp;*.svg;*.mp4;*.mov;*.zip;*.tar;*.gz;*.lock"
        # 发布目标（默认指向 plane-test 仓库 main 分支 ai-report 根目录）
        REPORT_PUBLISH_ENABLE: "1"
        REPORT_PUBLISH_REPO_URL: "https://cnb.cool/1024hub/plane-test"
        REPORT_PUBLISH_BRANCH: "main"
        REPORT_PUBLISH_DIR: "ai-report"
      # 秘钥仓库导入（参考 .cnb/web_trigger.yml 的 ENV_URL）
      imports: https://cnb.cool/1024hub/Deploy/PlaneCabbConf/-/blob/main/env.yml
      stages:
        - name: Install deps and generate daily report
          image: node:20
          timeout: 20m
          script:
            - |
              # use POSIX sh options (dash) — avoid pipefail
              set -eu
              apt-get update -y >/dev/null
              DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends git curl ca-certificates tzdata >/dev/null
              git --version
              # Install opencode CLI
              if ! command -v opencode >/dev/null 2>&1; then
                (curl -fsSL https://opencode.ai/install | bash) || true
              fi
              if ! command -v opencode >/dev/null 2>&1; then
                npm i -g opencode-ai || true
                export PATH="$(npm root -g)/.bin:$PATH"
              fi
              bash scripts/opencode_daily_report.sh
              if [ -d reports ] && ls -1 reports/*.json >/dev/null 2>&1; then
                ls -lah reports
                echo "----- 汇报预览 -----"
                head -n 80 $(ls -1t reports/*.json | head -n 1) || true
                echo "----- 预览结束 -----"
              else
                echo "no report generated" >&2
              fi

"**":
  web_trigger_daily_report:
    - name: web-manual-opencode-report
      env:
        TZ: Asia/Shanghai
        RUNNER_ARCH: cnb:arch:amd64
        OPENCODE_MODEL: "opencode/grok-code"
        ZEN_MODE: "1"
        # 手动触发默认统计“昨天”，可在按钮输入中覆盖
        REPORT_TIMEFRAME: "yesterday"
        # 手动触发默认启用采样补丁
        REPORT_DIFF_MODE: "sampled_patch"
        REPORT_DIFF_CHAR_BUDGET: "200000"
        REPORT_DIFF_TOP_FILES: "20"
        REPORT_DIFF_HUNKS_PER_FILE: "3"
        REPORT_DIFF_MAX_COMMITS: "100"
        REPORT_NUMSTAT_LINES: "5000"
        REPORT_EXCLUDE_GLOBS: "node_modules/**;dist/**;vendor/**;*.min.*;*.png;*.jpg;*.jpeg;*.gif;*.webp;*.svg;*.mp4;*.mov;*.zip;*.tar;*.gz;*.lock"
        # 要求 AI 汇总成功，否则任务失败（更贴合“必须AI理解后汇报”的诉求）
        REQUIRE_AI_SUMMARY: "1"
        # 发布目标默认启用
        REPORT_PUBLISH_ENABLE: "1"
        REPORT_PUBLISH_REPO_URL: "https://cnb.cool/1024hub/plane-test"
        REPORT_PUBLISH_BRANCH: "main"
        REPORT_PUBLISH_DIR: "ai-report"
      imports: https://cnb.cool/1024hub/Deploy/PlaneCabbConf/-/blob/main/env.yml
      stages:
        - name: Install deps and generate daily report
          image: node:20
          timeout: 20m
          script:
            - |
              # use POSIX sh options (dash) — avoid pipefail
              set -eu
              apt-get update -y >/dev/null
              DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends git curl ca-certificates tzdata >/dev/null
              git --version
              # Install opencode CLI
              if ! command -v opencode >/dev/null 2>&1; then
                (curl -fsSL https://opencode.ai/install | bash) || true
              fi
              if ! command -v opencode >/dev/null 2>&1; then
                npm i -g opencode-ai || true
                export PATH="$(npm root -g)/.bin:$PATH"
              fi
              bash scripts/opencode_daily_report.sh
              if [ -d reports ] && ls -1 reports/*.json >/dev/null 2>&1; then
                ls -lah reports
                echo "----- 汇报预览 -----"
                head -n 80 $(ls -1t reports/*.json | head -n 1) || true
                echo "----- 预览结束 -----"
              else
                echo "no report generated" >&2
              fi
  "crontab: 0 5 * * 1":
    - name: weekly-opencode-report
      env:
        TZ: Asia/Shanghai
        RUNNER_ARCH: cnb:arch:amd64
        OPENCODE_MODEL: "opencode/grok-code"
        # 上一自然周（周一至周日）
        REPORT_TIMEFRAME: "last_week"
        ZEN_MODE: "1"
        # AI 必达 + 采样补丁
        REQUIRE_AI_SUMMARY: "1"
        REPORT_DIFF_MODE: "sampled_patch"
        REPORT_DIFF_CHAR_BUDGET: "200000"
        REPORT_DIFF_TOP_FILES: "20"
        REPORT_DIFF_HUNKS_PER_FILE: "3"
        REPORT_DIFF_MAX_COMMITS: "100"
        REPORT_NUMSTAT_LINES: "5000"
        REPORT_EXCLUDE_GLOBS: "node_modules/**;dist/**;vendor/**;*.min.*;*.png;*.jpg;*.jpeg;*.gif;*.webp;*.svg;*.mp4;*.mov;*.zip;*.tar;*.gz;*.lock"
        # 发布目标
        REPORT_PUBLISH_ENABLE: "1"
        REPORT_PUBLISH_REPO_URL: "https://cnb.cool/1024hub/plane-test"
        REPORT_PUBLISH_BRANCH: "main"
        REPORT_PUBLISH_DIR: "ai-report"
      imports: https://cnb.cool/1024hub/Deploy/PlaneCabbConf/-/blob/main/env.yml
      stages:
        - name: Install deps and generate weekly report
          image: node:20
          timeout: 20m
          script:
            - |
              # use POSIX sh options (dash) — avoid pipefail
              set -eu
              apt-get update -y >/dev/null
              DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends git curl ca-certificates tzdata >/dev/null
              git --version
              # Install opencode CLI
              if ! command -v opencode >/dev/null 2>&1; then
                (curl -fsSL https://opencode.ai/install | bash) || true
              fi
              if ! command -v opencode >/dev/null 2>&1; then
                npm i -g opencode-ai || true
                export PATH="$(npm root -g)/.bin:$PATH"
              fi
              bash scripts/opencode_daily_report.sh
              if [ -d reports ] && ls -1 reports/*.json >/dev/null 2>&1; then
                ls -lah reports
                echo "----- 汇报预览 -----"
                head -n 80 $(ls -1t reports/*.json | head -n 1) || true
                echo "----- 预览结束 -----"
              else
                echo "no report generated" >&2
              fi

  "crontab: 0 1 1 * *":
    - name: monthly-opencode-report
      env:
        TZ: Asia/Shanghai
        RUNNER_ARCH: cnb:arch:amd64
        OPENCODE_MODEL: "opencode/grok-code"
        # 上一个自然月
        REPORT_TIMEFRAME: "last_month"
        ZEN_MODE: "1"
        # AI 必达 + 采样补丁
        REQUIRE_AI_SUMMARY: "1"
        REPORT_DIFF_MODE: "sampled_patch"
        REPORT_DIFF_CHAR_BUDGET: "200000"
        REPORT_DIFF_TOP_FILES: "20"
        REPORT_DIFF_HUNKS_PER_FILE: "3"
        REPORT_DIFF_MAX_COMMITS: "100"
        REPORT_NUMSTAT_LINES: "5000"
        REPORT_EXCLUDE_GLOBS: "node_modules/**;dist/**;vendor/**;*.min.*;*.png;*.jpg;*.jpeg;*.gif;*.webp;*.svg;*.mp4;*.mov;*.zip;*.tar;*.gz;*.lock"
        # 发布目标
        REPORT_PUBLISH_ENABLE: "1"
        REPORT_PUBLISH_REPO_URL: "https://cnb.cool/1024hub/plane-test"
        REPORT_PUBLISH_BRANCH: "main"
        REPORT_PUBLISH_DIR: "ai-report"
      imports: https://cnb.cool/1024hub/Deploy/PlaneCabbConf/-/blob/main/env.yml
      stages:
        - name: Install deps and generate monthly report
          image: node:20
          timeout: 20m
          script:
            - |
              # use POSIX sh options (dash) — avoid pipefail
              set -eu
              apt-get update -y >/dev/null
              DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends git curl ca-certificates tzdata >/dev/null
              git --version
              # Install opencode CLI
              if ! command -v opencode >/dev/null 2>&1; then
                (curl -fsSL https://opencode.ai/install | bash) || true
              fi
              if ! command -v opencode >/dev/null 2>&1; then
                npm i -g opencode-ai || true
                export PATH="$(npm root -g)/.bin:$PATH"
              fi
              bash scripts/opencode_daily_report.sh
              if [ -d reports ] && ls -1 reports/*.json >/dev/null 2>&1; then
                ls -lah reports
                echo "----- 汇报预览 -----"
                head -n 80 $(ls -1t reports/*.json | head -n 1) || true
                echo "----- 预览结束 -----"
              else
                echo "no report generated" >&2
              fi
