# .cnb/web_trigger.yml
# 复用服务选项
service_options: &service_options
  - name: server
    value: server

# 复用服务列表配置
services_list_input: &services_list_input
  description: 需要构建的服务列表
  required: true
  type: select
  multiple: true
  options: *service_options

# 日报时间范围输入（手动触发）
report_timeframe_input: &report_timeframe_input
  description: 生成日报的统计时间范围
  required: false
  type: select
  default: yesterday
  options:
    - name: 昨天
      value: yesterday
    - name: 上周
      value: last_week
    - name: 上个月
      value: last_month

branch:
  - reg: "^ma"
    buttons:
      - name: <!!!生产-开始构建!!!>
        description: 构建到生产环境
        event: web_trigger_release
        env:
          RUNNER_ARCH: cnb:arch:amd64
          ENV_URL: "https://cnb.cool/1024hub/Deploy/PlaneCabbConf/-/blob/main/env.yml"
          BRANCH: "main"
        inputs:
          SERVICES_LIST: *services_list_input
      - name: 生成汇报
        description: 汇总 git 提交并生成工作日报
        event: web_trigger_daily_report
        env:
          RUNNER_ARCH: cnb:arch:amd64
          ENV_URL: "https://cnb.cool/1024hub/Deploy/PlaneCabbConf/-/blob/main/env.yml"
        inputs:
          REPORT_TIMEFRAME: *report_timeframe_input
          REPORT_PUBLISH_ENABLE:
            name: 是否推送到仓库
            description: 将汇报文件提交到目标仓库
            required: false
            type: switch
            default: "true"
            options:
              - name: 启用
                value: "true"
              - name: 禁用
                value: "false"
          REPORT_PUBLISH_REPO_URL:
            name: 目标仓库 URL
            description: 例如 https://cnb.cool/1024hub/plane-test
            required: false
            type: input
            default: "https://cnb.cool/1024hub/plane-test"
          REPORT_PUBLISH_BRANCH:
            name: 目标分支
            required: false
            type: input
            default: "main"
          REPORT_PUBLISH_DIR:
            name: 目标目录根
            description: 汇报保存根目录
            required: false
            type: input
            default: "ai-report"
          REPORT_DIFF_MODE:
            name: 明细级别
            description: 统计-only 或包含采样补丁
            required: false
            type: select
            default: sampled_patch
            options:
              - name: 仅统计（最省）
                value: stats
              - name: 采样补丁（推荐）
                value: sampled_patch
              - name: 全量补丁（谨慎）
                value: full_patch
          REPORT_DIFF_CHAR_BUDGET:
            name: 字符预算
            description: 补丁上下文总字符上限
            required: false
            type: input
            default: "200000"
          REPORT_DIFF_TOP_FILES:
            name: 每提交 Top 文件数
            required: false
            type: input
            default: "20"
          REPORT_DIFF_HUNKS_PER_FILE:
            name: 每文件最多 hunk 数
            required: false
            type: input
            default: "3"
          REPORT_DIFF_MAX_COMMITS:
            name: 最多处理提交数
            required: false
            type: input
            default: "100"
          REPORT_NUMSTAT_LINES:
            name: numstat 最大行数
            required: false
            type: input
            default: "5000"
          REPORT_EXCLUDE_GLOBS:
            name: 排除路径（;分隔）
            required: false
            type: textarea
            default: "node_modules/**;dist/**;vendor/**;*.min.*;*.png;*.jpg;*.jpeg;*.gif;*.webp;*.svg;*.mp4;*.mov;*.zip;*.tar;*.gz;*.lock"
  - buttons:
      - name: <!!!测试-开始构建!!!>
        description: 构建到测试环境
        event: web_trigger_test
        env:
          RUNNER_ARCH: cnb:arch:amd64
          ENV_URL: "https://cnb.cool/1024hub/Deploy/PlaneCabbConf/-/blob/develop/env.yml"
          BRANCH: "develop"
        inputs:
          SERVICES_LIST: *services_list_input
      - name: 生成汇报
        description: 汇总 git 提交并生成工作日报
        event: web_trigger_daily_report
        env:
          RUNNER_ARCH: cnb:arch:amd64
          ENV_URL: "https://cnb.cool/1024hub/Deploy/PlaneCabbConf/-/blob/main/env.yml"
        inputs:
          REPORT_TIMEFRAME: *report_timeframe_input
          REPORT_PUBLISH_ENABLE:
            name: 是否推送到仓库
            description: 将汇报文件提交到目标仓库
            required: false
            type: switch
            default: "true"
            options:
              - name: 启用
                value: "true"
              - name: 禁用
                value: "false"
          REPORT_PUBLISH_REPO_URL:
            name: 目标仓库 URL
            description: 例如 https://cnb.cool/1024hub/plane-test
            required: false
            type: input
            default: "https://cnb.cool/1024hub/plane-test"
          REPORT_PUBLISH_BRANCH:
            name: 目标分支
            required: false
            type: input
            default: "main"
          REPORT_PUBLISH_DIR:
            name: 目标目录根
            description: 汇报保存根目录
            required: false
            type: input
            default: "ai-report"
          REPORT_DIFF_MODE:
            name: 明细级别
            description: 统计-only 或包含采样补丁
            required: false
            type: select
            default: sampled_patch
            options:
              - name: 仅统计（最省）
                value: stats
              - name: 采样补丁（推荐）
                value: sampled_patch
              - name: 全量补丁（谨慎）
                value: full_patch
          REPORT_DIFF_CHAR_BUDGET:
            name: 字符预算
            description: 补丁上下文总字符上限
            required: false
            type: input
            default: "200000"
          REPORT_DIFF_TOP_FILES:
            name: 每提交 Top 文件数
            required: false
            type: input
            default: "20"
          REPORT_DIFF_HUNKS_PER_FILE:
            name: 每文件最多 hunk 数
            required: false
            type: input
            default: "3"
          REPORT_DIFF_MAX_COMMITS:
            name: 最多处理提交数
            required: false
            type: input
            default: "100"
          REPORT_NUMSTAT_LINES:
            name: numstat 最大行数
            required: false
            type: input
            default: "5000"
          REPORT_EXCLUDE_GLOBS:
            name: 排除路径（;分隔）
            required: false
            type: textarea
            default: "node_modules/**;dist/**;vendor/**;*.min.*;*.png;*.jpg;*.jpeg;*.gif;*.webp;*.svg;*.mp4;*.mov;*.zip;*.tar;*.gz;*.lock" 
