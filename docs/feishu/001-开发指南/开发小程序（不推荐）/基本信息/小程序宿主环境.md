---
title: "小程序宿主环境"
source_url: https://open.feishu.cn/document/client-docs/gadget/introduction/host-environment
last_remote_update: 2023-08-25
last_remote_update_timestamp: 1692947455000
---
最后更新于 2023-08-25

# 小程序宿主环境

小程序宿主环境是指，飞书客户端（包括 PC 端和移动端）为小程序提供运行时所需要的环境以及各种能力。小程序以宿主环境作为支撑，可以实现相较于 Web 网页更加丰富的功能，从而使小程序的使用者获得更加流畅的体验与交互。

## 逻辑层和视图层

小程序的运行环境分为逻辑层和视图层。

- 逻辑层是加载小程序应用的 JS 脚本，负责处理业务逻辑。

- 视图层负责渲染 TTML 模板和 TTSS 样式，以显示页面。

小程序的逻辑层和视图层由两个独立的线程进行管理。逻辑层的线程启动 JSCore 引擎来执行 JS 脚本，处理业务逻辑。视图层的每个页面使用一个 Webview 进行渲染，多个页面则对应多个 Webview。因此，一个小程序应用只有一个 JSCore 线程，但有多个 Webview 线程。小程序整体的运行环境和通信模型如下图所示。

![image.png](https://sf3-cn.feishucdn.com/obj/open-platform-opendoc/d83692d2d8f024b2eeac430507ceae8f_rG6jFH8AJp.png?height=1002&lazyload=true&maxWidth=600&width=1332)

上图中的 Mobile/PC 客户端模块即为小程序的宿主环境。客户端分别与视图层、逻辑层进行通信和数据交互。视图层和逻辑层之间无法直接通信，只能通过客户端作为桥来通信。

## 程序与页面

在飞书客户端打开小程序时，系统首先会将小程序的代码包下载到本地，然后解析 app.json 里的`pages`字段，即可获取该小程序的所有页面路径。示例代码片段如下：

```javascript
{
  "pages":[
    "pages/index/index",
    "pages/home/home"
  ]
}
```

其中，`pages`里配置的第一个值，就是打开小程序应用时所看到的第一个页面。每个页面路径在程序代码包里都可以找到对应的文件夹路径。例如，`pages/index/index`，在该路径下，存在当前页面对应的 TTML、TTSS 和 JS 文件。当小程序启动后，系统根据页面路径找到对应页面的代码文件，然后交给逻辑层和视图层执行，后续使用者便可在客户端上看到该页面。

当小程序启动之后，会触发 app.js 里定义的`onLaunch`方法，代码片段如下所示。

```javascript
App({
  onLaunch: function () {
    // 小程序启动之后执行
  }
})
```warning
移动端的一个小程序只存在一个实例，而桌面端的同一个小程序，每个模式下均会存在唯一的实例（桌面端小程序有多种模式，详见 [桌面端小程序运行模式](https://open.feishu.cn/document/uYjL24iN/uIjNzUjLyYzM14iM2MTN#37991f21)）。

关于小程序的页面结构和具体构成，以`pages/index/index`为例说明如下，该文件目录下存在 index.js、index.ttml、index.ttss 文件。

```javascript
// index.js 的内容
Page({
  data: {

},
  onLoad: function () {
    console.log('Welcome to Mini Code')
  },
})
```

在 index.js 文件里：

- `Page({...})`构造出该 index 页面实例，`data`表示的是该页面需要用到的渲染数据。

- 当生成页面时，小程序引擎会把`data`数据和 index.ttml 文件结合，再渲染出来显示到前端。

- `onLoad()`方法是页面的生命周期方法，页面创建时会回调该方法，小程序的开发者可在里面自定义业务逻辑。

## 组件

你可以通过小程序组件创建页面 UI、自定义 TTML，支持灵活自由的组合各类组件，去构建符合业务需求的页面 UI。组件说明如下：

- 在 TTML 中使用组件，是视图层的基本组成单元。

- 一个组件通常包括开始标签和结束标签，可以通过属性修饰组件，内容在两个标签之内。
所有组件与属性均为小写，以连字符`-`连接。

组件类似于 HTML 的标签，在小程序里，你可以在 TTML 里写上对应组件的标签，后续即可显示出来。例如：

```javascript
// index.ttml 内容
<view class="intro">Welcome to Gadget</view>
```

该示例页面会显示一行`Welcome to Gadget`文案，其中，你可以通过`style`和`class`来控制该组件的样式，例如，指定宽、高、颜色等。

更多组件相关的内容可参考 [小程序的组件](https://open.feishu.cn/document/uYjL24iN/ugTNugTNugTN)。

## API 

为了让你很方便的使用飞书提供的能力，例如，获取用户信息、获取设备当前的地理位置、播放视频等，小程序提供了丰富的 API 供你使用，这些 API 分为异步、同步两种。

- 异步 API 通过回调，返回结果。

- 同步 API 直接返回结果。

API 示例代码如下：

- 获取用户信息

```javascript
tt.getUserInfo({ 
    success (res) { 
        console.log(`getUserInfo 调用成功 ${res.userInfo}`); 
    }, 
    fail (res) { 
        console.log(`getUserInfo 调用失败`); 
    } 
});
```

- 获取设备当前的地理位置

```javascript
tt.getLocation({ 
    success (res) { 
        console.log(`经度 ${res.longitude}，纬度 ${res.latitude}`); 
    }, 
    fail (res) { 
        console.log(`getLocation 调用失败`); 
    } 
});
```
- 多数 API 都是基于异步回调，所以你需要处理好异步逻辑，传入正确的回调函数去处理业务。

- 更多 API 相关的内容，参见 [小程序的 API](https://open.feishu.cn/document/uYjL24iN/uADOy4CM4IjLwgjM)。
