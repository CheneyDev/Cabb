---
title: "数据协同"
source_url: https://open.feishu.cn/document/client-docs/block/basic-ability/collaborative
last_remote_update: 2022-07-15
last_remote_update_timestamp: 1657878477000
---
最后更新于 2022-07-15

# 数据协同

## 功能简介

一些业务场景下数据变更通过刷新页面才感知，但是一部分业务场景下，有数据变更能够实时协同需求。

Block 提供了数据协同能力，需要注意的是，协同能力是可选的，开发者应该根据诉求自行选择接入。如，在云文档中，某个用户操作了 block 后，其他用户也能看到该 block 发生了变化。

我们提供了两类数据协同能力：

1. BlockEntity 数据协同。即同一 blockID，不同用户收到推送内容相同。
2. 用户维度数据协同。即同一 blockID，部分用户能够收到推送，并且不同用户之间收到的推送内容可以不同。

## BlockEntity 数据协同

BlockEntity 数据协同主要针对非个性化数据的推送，即在线的相同 blockID 的 block 将收到内容相同的数据推送。如，投票 Block，当投票内容发生变化，所有使用了该 blockID 的在线设备都会收到相同投票结果信息。

### 业务流程

![image.png](https://sf3-cn.feishucdn.com/obj/open-platform-opendoc/a13d71d56421c9ce569b867f4814f3a6_C5tC71ek9L.png?lazyload=true&width=1640&height=576)

开发者服务端需要映射业务 id 与 blockID 关系，因为变更推送是以 blockID 为主键。
具体绑定方式为：在[服务端创建流程](https://open.feishu.cn/document/uAjLw4CM/uYjL24iN/block/service/create)中，开发者服务端将业务数据发送至开放平台，开放平台返回 blockID，从而开发者服务端可以将业务 id 与 blockID 实现绑定。

### 接入协同

#### 客户端监听变化

开发者需要在 Block 中监听数据的推送。当开发者推送更新数据后，Block 框架会通过开放平台收到数据推送，并通过 `onResourceChange` 生命周期将数据提供给开发者 Block。
在服务端发送事件会确定 version，因此 `onResourceChange` 收到数据一定会是按序的。

示例代码如下。详细代码可以参考[Block](https://open.feishu.cn/document/uAjLw4CM/uYjL24iN/block/block-frame/framework-interface/block)。

```js
Block({
  // 这里 sourceData 可拿到推送的数据
  onResourceChange(sourceData) {
    console.log(sourceData);
  },
});
```

#### 服务端推送更新

具体调用接口请参考[更新 BlockEntity](https://open.feishu.cn/document/uAjLw4CM/ukTMukTMukTM/block-v2/entity/update)。

## 用户维度数据协同

BlockEntity 数据协同，并不能解决一些场景下对数据推送的诉求，因此还提供用户维度数据协同。包括但不限于以下场景：
- 以用户为维度的变更推送，如消息 badge，同一时间少部分用户能收到推送，并且数据不同。
- 千人千面的个性化数据，如订阅新闻，同一时间用户能收到内容不同的推送。

### 业务流程

![image.png](https://sf3-cn.feishucdn.com/obj/open-platform-opendoc/24cd58e9a0b1c660421c4961154ab0fa_4aDNofxC4E.png?lazyload=true&width=1640&height=662)

只有满足在指定用户列表内，指定 blockID 在线的设备才能收到消息推送，即指定的用户指定 blockID 离线将收不到消息。

### 业务接入
#### 客户端监听变化

开发者需要在 Block 中监听数据的推送。当开发者推送更新数据后，Block 框架会通过开放平台收到数据推送，并通过 onTypedMessage 生命周期将数据提供给开发者 Block。
- 在服务端发送事件会确定 version，当客户端接收的版本小于本地版本会放弃该变更。
- blockit-sdk 版本要求：1.5.0 及以上版本。
示例代码如下：
```JavaScript
Block({
  onTypedMessage(message) {
    console.log(message.type, message.data);
    // 业务逻辑，比如更新视图
  }
});
```

#### 服务端推送消息

具体调用接口[Block消息推送](https://open.feishu.cn/document/uAjLw4CM/ukTMukTMukTM/block-v2/message/create)。
关于触发时机需要同时满足两个条件：
- 外部有消息推送
- 应用启动完成后

为了确保消息能正常推送到 Block 业务，尽量选择应用启动完成之后推送或者在应用启动后直接拉取消息
