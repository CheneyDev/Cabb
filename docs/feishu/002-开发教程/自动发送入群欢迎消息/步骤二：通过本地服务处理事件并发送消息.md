---
title: "步骤二：通过本地服务处理事件并发送消息"
source_url: https://open.feishu.cn/document/event-based-messaging/message-card-reference
last_remote_update: 2024-02-18
last_remote_update_timestamp: 1708253158000
---
最后更新于 2024-02-18

# 步骤二：通过本地服务处理事件并发送消息

本地服务收到订阅的 **用户进群** 事件后，需要处理事件数据并向目标群发送消息。本章节主要介绍实现消息发送的代码逻辑，并提供相应的 JavaScript 代码片段供你参考。你需要根据本地服务的实际情况，自行完善代码以实现事件处理与消息发送。

## 代码逻辑说明

1. 识别用户进群事件。

由于订阅的事件可能不止一个，因此需要通过 **用户进群** 事件的特征，识别该事件。根据 [用户进群](https://open.feishu.cn/document/uAjLw4CM/ukTMukTMukTM/reference/im-v1/chat-member-user/events/added) 事件文档，获取该事件的关键特征：事件类型（`header.event_type`）为`im.chat.member.user.added_v1`。

2. 获取事件中的用户信息。

当收到 **用户进群** 事件后，参考[用户进群](https://open.feishu.cn/document/uAjLw4CM/ukTMukTMukTM/reference/im-v1/chat-member-user/events/added)事件文档，可以通过以下参数定位用户与群信息，后续用于构造消息并向指定群发送消息。

- `event.users`：添加进群的用户列表。
    - `event.chat_id`：对应的群 ID。

3. 调用飞书 OpenAPI 发送消息。

调用[发送消息](https://open.feishu.cn/document/uAjLw4CM/ukTMukTMukTM/reference/im-v1/message/create) OpenAPI，构造一条欢迎消息并@进群用户，通过指定群 ID 向该群发送消息。

## 示例代码

整体逻辑用 JavaScript 代码描述如下。

```JavaScript
const axios = require('axios')
// 假设data为回调过来的事件体原始内容。
async function group_member_greet(data) {
    if (data.header.event_type !== 'im.chat.member.user.added_v1') {
      // 不是用户进群事件则忽略。
      return
    }
  // 在事件中获取用户 open_id。
  const users_info = data.event.users.map(x=>`<at id=${x.user_id.open_id}></at>`).join("")
  // 构造欢迎消息。
  const card = {
    "header": {
      "title": {
        "tag": "lark_md",
        "i18n": {
          "zh_cn": "欢迎新同学"
        }
      }
    },
    "i18n_elements": {
      "zh_cn": [
        {
          "tag": "div",
          "fields": [
            {
              "is_short": false,
              "text": {
                "tag": "markdown",
                "content": `亲爱的${users_info}，欢迎入群！👏🏻`
              }
            }
          ]
        }
      ]
    }
  }
  try {
    // 调用发送消息 OpenAPI。
    const resp = await axios.post("https://open.feishu.cn/open-apis/im/v1/messages?receive_id_type=chat_id", {
      receive_id: data.event.chat_id,
      msg_type: "interactive",
      content: JSON.stringify({card})
    })
    return {
      code: resp.data.code,
      msg: resp.data.msg
    }
  } catch(e) {
    return {
      code: -1,
      msg: `${e}`
    }
  }
}
```
